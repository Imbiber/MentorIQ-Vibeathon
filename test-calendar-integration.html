<!DOCTYPE html>
<html>
<head>
    <title>Calendar Integration Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        button { padding: 10px 20px; margin: 10px; display: block; }
        .result { margin: 10px 0; padding: 10px; background: #f5f5f5; border-radius: 5px; }
        .success { background: #e8f5e9; color: #2e7d32; }
        .error { background: #ffebee; color: #c62828; }
        .info { background: #e3f2fd; color: #1565c0; }
    </style>
</head>
<body>
    <h1>Calendar Integration Test</h1>
    
    <button onclick="checkTokens()">Check Stored Tokens</button>
    <button onclick="testOAuth()">Test OAuth Flow</button>
    <button onclick="testCalendarApi()">Test Calendar API Direct</button>
    <button onclick="clearTokens()">Clear Tokens</button>
    
    <div id="results"></div>
    
    <script>
        const CLIENT_ID = '542756320480-glsal5u9qait02m8ih42f53di9pb4vlo.apps.googleusercontent.com';
        const SCOPES = 'https://www.googleapis.com/auth/calendar https://www.googleapis.com/auth/calendar.events https://www.googleapis.com/auth/userinfo.email';
        
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong> - ${message}`;
            document.getElementById('results').appendChild(div);
            console.log(message);
        }
        
        function checkTokens() {
            const accessToken = localStorage.getItem('google_access_token');
            const expiry = localStorage.getItem('google_token_expiry');
            const refreshToken = localStorage.getItem('google_refresh_token');
            
            if (accessToken) {
                const expiryDate = new Date(parseInt(expiry));
                const isExpired = Date.now() > expiryDate;
                log(`‚úÖ Access token found (expires: ${expiryDate.toLocaleString()}, expired: ${isExpired})`, 'success');
                if (refreshToken) {
                    log(`‚úÖ Refresh token also available`, 'success');
                }
            } else {
                log('‚ùå No access token found in localStorage', 'error');
            }
        }
        
        function testOAuth() {
            const state = Math.random().toString(36).substring(7);
            const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?` +
                `client_id=${encodeURIComponent(CLIENT_ID)}&` +
                `redirect_uri=${encodeURIComponent('http://localhost:8080/auth/google/callback')}&` +
                `scope=${encodeURIComponent(SCOPES)}&` +
                `response_type=code&` +
                `state=${state}&` +
                `access_type=offline&` +
                `prompt=consent`;
            
            log('üîÑ Opening OAuth popup...', 'info');
            const popup = window.open(authUrl, 'oauth', 'width=500,height=600');
            
            if (!popup) {
                log('‚ùå Popup blocked', 'error');
                return;
            }
            
            const checkClosed = setInterval(() => {
                if (popup.closed) {
                    clearInterval(checkClosed);
                    setTimeout(() => checkTokens(), 1000);
                }
            }, 1000);
        }
        
        async function testCalendarApi() {
            const token = localStorage.getItem('google_access_token');
            if (!token) {
                log('‚ùå No token available. Run OAuth first.', 'error');
                return;
            }
            
            log('üîÑ Testing direct Google Calendar API...', 'info');
            
            try {
                // Test creating a simple calendar event
                const event = {
                    summary: 'üß™ Test Event from MentorIQ',
                    description: 'This is a test event created by the MentorIQ calendar integration test.',
                    start: {
                        dateTime: new Date(Date.now() + 60 * 60 * 1000).toISOString(), // 1 hour from now
                        timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
                    },
                    end: {
                        dateTime: new Date(Date.now() + 2 * 60 * 60 * 1000).toISOString(), // 2 hours from now
                        timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
                    }
                };
                
                const response = await fetch('https://www.googleapis.com/calendar/v3/calendars/primary/events', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(event)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    log(`‚úÖ Event created successfully! ID: ${result.id}`, 'success');
                    log(`üìÖ Event link: ${result.htmlLink}`, 'success');
                } else {
                    const error = await response.json();
                    log(`‚ùå Calendar API error: ${error.error?.message || response.statusText}`, 'error');
                }
                
            } catch (error) {
                log(`‚ùå Network error: ${error.message}`, 'error');
            }
        }
        
        function clearTokens() {
            localStorage.removeItem('google_access_token');
            localStorage.removeItem('google_token_expiry');
            localStorage.removeItem('google_refresh_token');
            log('‚úÖ All tokens cleared', 'success');
        }
        
        // Check tokens on page load
        window.onload = () => {
            log('üìç Calendar Integration Test loaded', 'info');
            checkTokens();
        };
    </script>
</body>
</html>